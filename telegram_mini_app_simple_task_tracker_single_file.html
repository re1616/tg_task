<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tasky – Telegram Mini App</title>
  <style>
    :root {
      --bg: #0e1621;
      --text: #fff;
      --muted: #b0b8c4;
      --card: #131c26;
      --accent: #2ea6ff;
      --accent-contrast: #001e33;
      --border: #22303e;
      --danger: #ff4d4f;
      --success: #30d158;
    }
    [data-theme="light"] {
      --bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --card: #f3f4f6;
      --accent: #0ea5e9;
      --accent-contrast: #e0f2fe;
      --border: #e5e7eb;
      --danger: #dc2626;
      --success: #16a34a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px 16px 96px; /* space for Telegram bottom bar */
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-contrast));
      display: grid; place-items: center;
      color: #0b1220; font-weight: 800;
      border: 1px solid var(--border);
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.15);
    }
    h1 { font-size: 18px; margin: 0; }
    .muted { color: var(--muted); font-size: 12px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }

    .row { display: flex; gap: 8px; }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }
    button {
      border: 1px solid var(--border);
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button.ghost { background: transparent; color: var(--text); }

    ul { list-style: none; margin: 12px 0 0; padding: 0; }
    li.task {
      display: grid;
      grid-template-columns: 28px 1fr 28px;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.04);
      margin-bottom: 8px;
    }
    .task.done .title { text-decoration: line-through; opacity: .6; }
    .task .title { word-break: break-word; }
    .task .badge { font-size: 10px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); }
    .task .actions { display: flex; gap: 6px; justify-self: end; }

    .filters { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-top: 10px; }
    .tabs { display: inline-flex; gap: 4px; border: 1px solid var(--border); padding: 4px; border-radius: 999px; }
    .tab { padding: 6px 10px; border-radius: 999px; background: transparent; color: var(--text); border: none; cursor: pointer; }
    .tab.active { background: var(--accent-contrast); color: var(--text); }

    .empty { text-align: center; color: var(--muted); padding: 24px 8px; }
  </style>
</head>
<body>
  <div class="wrap" id="app" data-theme="dark">
    <header>
      <div class="logo">✓</div>
      <div>
        <h1>Tasky</h1>
        <div class="muted">A tiny task tracker for Telegram</div>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <input id="taskInput" type="text" placeholder="What do you need to do?" />
        <button id="addBtn">Add</button>
      </div>
      <div class="filters">
        <div id="leftCount" class="muted">0 tasks left</div>
        <div class="tabs">
          <button class="tab active" data-filter="all">All</button>
          <button class="tab" data-filter="active">Active</button>
          <button class="tab" data-filter="done">Done</button>
        </div>
      </div>
      <ul id="list"></ul>
      <div class="row" style="margin-top:8px;">
        <button id="clearCompleted" class="ghost">Clear completed</button>
        <button id="exportBtn" class="ghost" style="margin-left:auto;">Export</button>
        <button id="importBtn" class="ghost">Import</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
      <div id="empty" class="empty" hidden>Nothing here yet. Add your first task!</div>
    </section>
  </div>

  <script>
    // --- Telegram WebApp bootstrap (safe in any browser for local testing) ---
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    const haptic = tg && tg.HapticFeedback ? tg.HapticFeedback : { impactOccurred:()=>{}, notificationOccurred:()=>{} };

    function applyThemeFromTelegram() {
      const root = document.getElementById('app');
      if (!tg) return;
      const p = tg.themeParams || {};
      const isDark = (tg.colorScheme || 'dark') === 'dark';
      root.dataset.theme = isDark ? 'dark' : 'light';
      // Map Telegram theme params if available
      const m = {
        '--bg': p.bg_color,
        '--text': p.text_color,
        '--muted': p.hint_color,
        '--card': p.secondary_bg_color,
        '--accent': p.button_color,
        '--accent-contrast': p.button_text_color,
        '--border': p.section_separator_color,
      };
      for (const k in m) {
        if (m[k]) root.style.setProperty(k, m[k]);
      }
    }

    // Expand to full height and set the main button
    if (tg) {
      tg.ready();
      tg.expand();
      tg.MainButton.setText('Add task');
      tg.MainButton.show();
      tg.onEvent('mainButtonClicked', () => {
        document.getElementById('addBtn').click();
      });
      tg.onEvent('themeChanged', applyThemeFromTelegram);
      applyThemeFromTelegram();
    }

    // --- Minimal state / storage ---
    const userId = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) || 'anon';
    const STORAGE_KEY = `tasky_tasks_${userId}`;
    let tasks = load();
    let filter = 'all';

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
    function load() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    // --- DOM helpers ---
    const $ = (sel) => document.querySelector(sel);
    const list = $('#list');
    const input = $('#taskInput');
    const leftCount = $('#leftCount');
    const empty = $('#empty');

    function uuid() { return Math.random().toString(36).slice(2,9); }

    function render() {
      list.innerHTML = '';
      const filtered = tasks.filter(t =>
        filter === 'all' ? true : filter === 'active' ? !t.done : t.done
      );
      filtered.forEach(t => list.appendChild(renderItem(t)));
      const left = tasks.filter(t => !t.done).length;
      leftCount.textContent = `${left} task${left===1?'':'s'} left`;
      empty.hidden = tasks.length > 0;
    }

    function renderItem(t) {
      const li = document.createElement('li');
      li.className = 'task' + (t.done ? ' done' : '');
      li.dataset.id = t.id;

      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = t.done;
      cb.addEventListener('change', () => toggle(t.id));

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = t.title;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'ghost'; editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', () => edit(t.id));

      const delBtn = document.createElement('button');
      delBtn.className = 'ghost'; delBtn.textContent = 'Del';
      delBtn.addEventListener('click', () => del(t.id));

      li.append(cb, title, actions);
      actions.append(editBtn, delBtn);
      return li;
    }

    function add(title) {
      if (!title) return;
      tasks.unshift({ id: uuid(), title: title.trim(), done: false, ts: Date.now() });
      haptic.impactOccurred('light');
      save(); render();
    }
    function toggle(id) {
      const t = tasks.find(x => x.id === id); if (!t) return;
      t.done = !t.done; save(); render();
      haptic.impactOccurred('medium');
    }
    function del(id) {
      tasks = tasks.filter(x => x.id !== id); save(); render();
      haptic.notificationOccurred('warning');
    }
    function edit(id) {
      const t = tasks.find(x => x.id === id); if (!t) return;
      const val = prompt('Edit task', t.title);
      if (val !== null) { t.title = val.trim(); save(); render(); }
    }

    // --- Import/Export ---
    $('#exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'tasky-export.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    $('#importBtn').addEventListener('click', () => $('#importFile').click());
    $('#importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      try { tasks = JSON.parse(text); save(); render(); }
      catch { alert('Invalid file'); }
      e.target.value = '';
    });

    // --- UI wiring ---
    $('#addBtn').addEventListener('click', () => {
      const v = input.value.trim();
      if (v) { add(v); input.value = ''; input.focus(); }
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('#addBtn').click();
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        filter = tab.dataset.filter; render();
      });
    });

    document.getElementById('clearCompleted').addEventListener('click', () => {
      const before = tasks.length;
      tasks = tasks.filter(t => !t.done);
      if (tasks.length !== before) { save(); render(); }
    });

    // Initial render
    render();
  </script>
</body>
</html>
